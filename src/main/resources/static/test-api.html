<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project API Test</title>
  <style>
    body {
        font-family: monospace;
        padding: 20px;
        background: #f5f5f5;
    }
    .test-section {
        background: white;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
    }
    button:hover {
        background: #0056b3;
    }
    pre {
        background: #272822;
        color: #f8f8f2;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
    }
    .success { color: #28a745; }
    .error { color: #dc3545; }
  </style>
</head>
<body>
<h1>üîç Project API Test Tool</h1>

<div class="test-section">
  <h2>1. Login Credentials</h2>
  <input type="text" id="username" placeholder="Username" value="testuser">
  <input type="password" id="password" placeholder="Password" value="password123">
  <button onclick="testAuth()">Test Auth</button>
  <pre id="authResult"></pre>
</div>

<div class="test-section">
  <h2>2. Get Projects (Raw Response)</h2>
  <button onclick="getProjectsRaw()">Fetch Projects (Raw)</button>
  <pre id="projectsRaw"></pre>
</div>

<div class="test-section">
  <h2>3. Get Projects (Parsed)</h2>
  <button onclick="getProjectsParsed()">Fetch Projects (Parsed)</button>
  <div id="projectsParsed"></div>
</div>

<div class="test-section">
  <h2>4. Test Dashboard.js apiCall()</h2>
  <button onclick="testApiCall()">Test apiCall() Function</button>
  <pre id="apiCallResult"></pre>
</div>

<div class="test-section">
  <h2>5. Console Logs</h2>
  <pre id="consoleLogs">Check browser DevTools Console (F12) for detailed logs...</pre>
</div>

<script>
  const API_BASE = '/api';

  function getAuthHeader() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const credentials = btoa(`${username}:${password}`);
      return {
          'Authorization': `Basic ${credentials}`,
          'Content-Type': 'application/json'
      };
  }

  async function testAuth() {
      console.log('Testing authentication...');
      const resultEl = document.getElementById('authResult');

      try {
          const response = await fetch('/api/auth/login', {
              method: 'GET',
              headers: getAuthHeader()
          });

          if (response.ok) {
              const text = await response.text();
              resultEl.innerHTML = `<span class="success">‚úÖ Auth successful: ${text}</span>`;
              console.log('Auth OK');
          } else {
              resultEl.innerHTML = `<span class="error">‚ùå Auth failed: ${response.status}</span>`;
              console.error('Auth failed:', response.status);
          }
      } catch (error) {
          resultEl.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
          console.error('Auth error:', error);
      }
  }

  async function getProjectsRaw() {
      console.log('Fetching projects (raw)...');
      const resultEl = document.getElementById('projectsRaw');

      try {
          const response = await fetch('/api/projects', {
              method: 'GET',
              headers: getAuthHeader()
          });

          const text = await response.text();
          console.log('Raw response:', text);

          resultEl.innerHTML = `<span class="success">Status: ${response.status}</span>\n\n${text}`;

          // Try to parse
          try {
              const json = JSON.parse(text);
              console.log('Parsed JSON:', json);
          } catch (e) {
              console.error('JSON parse error:', e);
              resultEl.innerHTML += `\n\n<span class="error">‚ùå JSON Parse Error: ${e.message}</span>`;
          }
      } catch (error) {
          resultEl.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
          console.error('Fetch error:', error);
      }
  }

  async function getProjectsParsed() {
      console.log('Fetching projects (parsed)...');
      const resultEl = document.getElementById('projectsParsed');

      try {
          const response = await fetch('/api/projects', {
              method: 'GET',
              headers: getAuthHeader()
          });

          if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
          }

          const projects = await response.json();
          console.log('Parsed projects:', projects);

          if (!Array.isArray(projects)) {
              resultEl.innerHTML = `<span class="error">‚ùå Response is not an array: ${typeof projects}</span>`;
              return;
          }

          if (projects.length === 0) {
              resultEl.innerHTML = `<span class="error">‚ö†Ô∏è No projects found (empty array)</span>`;
              return;
          }

          resultEl.innerHTML = `
              <span class="success">‚úÖ Found ${projects.length} project(s)</span>
              <ul>
                  ${projects.map(p => `
                      <li>
                          <strong>${p.name}</strong><br>
                          ID: ${p.id}<br>
                          Files: ${p.totalFiles}<br>
                          Date: ${new Date(p.uploadedAt).toLocaleString()}<br>
                          <pre>${JSON.stringify(p, null, 2)}</pre>
                      </li>
                  `).join('')}
              </ul>
          `;
      } catch (error) {
          resultEl.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
          console.error('Parse error:', error);
      }
  }

  // Copy of dashboard.js apiCall function
  async function apiCall(endpoint, method = 'GET', body = null) {
      const headers = getAuthHeader();

      const options = {
          method,
          headers
      };

      if (body) {
          options.body = JSON.stringify(body);
      }

      console.log(`apiCall: ${method} ${API_BASE}${endpoint}`);
      console.log('Headers:', headers);
      if (body) console.log('Body:', body);

      try {
          const response = await fetch(`${API_BASE}${endpoint}`, options);

          console.log(`Response status: ${response.status}`);

          if (response.status === 401) {
              console.error('401 Unauthorized');
              return null;
          }

          if (!response.ok) {
              const error = await response.json();
              console.error('API error:', error);
              throw new Error(error.message || 'Request failed');
          }

          const data = await response.json();
          console.log('Response data:', data);
          return data;
      } catch (error) {
          console.error('API call failed:', error);
          throw error;
      }
  }

  async function testApiCall() {
      console.log('Testing apiCall() function...');
      const resultEl = document.getElementById('apiCallResult');

      try {
          const projects = await apiCall('/projects');
          console.log('apiCall result:', projects);

          if (projects && Array.isArray(projects)) {
              resultEl.innerHTML = `<span class="success">‚úÖ apiCall() works! Found ${projects.length} projects</span>\n\n${JSON.stringify(projects, null, 2)}`;
          } else {
              resultEl.innerHTML = `<span class="error">‚ùå apiCall() returned non-array: ${typeof projects}</span>\n\n${JSON.stringify(projects, null, 2)}`;
          }
      } catch (error) {
          resultEl.innerHTML = `<span class="error">‚ùå apiCall() failed: ${error.message}</span>`;
          console.error('apiCall error:', error);
      }
  }
</script>
</body>
</html>